{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Registos - {{ sector.nome }} - {{ data|date:"d/m/Y" }}{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
        color: white;
        border-radius: 8px 8px 0 0 !important;
    }
    .input-group-custom { position: relative; }
    .input-group-custom .form-control { padding-right: 2.5rem; text-align: right; }
    .input-group-custom .currency-symbol {
        position: absolute; right: 12px; top: 50%;
        transform: translateY(-50%); color: #6c757d; font-weight: 500;
    }
    .resumo-card {
        background: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 1rem; border-radius: 6px; margin-bottom: 1rem;
    }
    .resumo-valor { font-size: 1.1rem; font-weight: 600; }
    .entradas-card { border-left: 4px solid #198754; background: #f8fff9; }
    .saidas-card { border-left: 4px solid #dc3545; background: #fff8f8; }
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
    }
    .btn-success {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        border: none; font-weight: 600;
    }
    .numeric-input { text-align: right; }
    @media (max-width: 768px) {
        .container { padding: 0 10px; }
        .btn-lg { font-size: 1rem; padding: 0.75rem 1.5rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- üîπ Cabe√ßalho -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">
                        <i class="fas fa-edit me-2"></i>Editando {{ sector.nome }}
                    </h4>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar me-1"></i>{{ data|date:"d/m/Y" }} ‚Ä¢ 
                        <i class="fas fa-bus me-1"></i>{{ total_registros }}/{{ total_autocarros }} Autocarros
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="{% url 'listar_registros' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Formul√°rio √∫nico: relat√≥rio do setor + registros -->
    <form method="post" enctype="multipart/form-data" id="relatorioForm">
        {% csrf_token %}
        {{ relatorio_form.non_field_errors }}

        <!-- üîπ Despesa Geral e Descri√ß√£o (RelatorioSectorForm) -->
        {% with relatorio=forms.0.registro.relatorio %}
            {% if relatorio %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-white">
                        <i class="fas fa-wallet me-2"></i> Despesa Geral do Setor
                    </h6>
                    <span class="small text-white-50">
                        <i class="fas fa-calendar me-1"></i>{{ data|date:"d/m/Y" }}
                    </span>
                </div>

                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Despesa Geral -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Despesa Geral (Kz)</label>
                            <div class="input-group-custom">
                                {{ relatorio_form.despesa_geral }}
                                <span class="currency-symbol">Kz</span>
                            </div>
                            {% if relatorio_form.despesa_geral.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ relatorio_form.despesa_geral.errors.as_text }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Comprovativos -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">
                                <i class="fas fa-file-alt me-1 text-primary"></i>Comprovativos
                            </label>
                            <input type="file" name="novos_comprovativos" multiple class="form-control form-control-sm">
                            {% if relatorio.comprovativos.exists %}
                                <div class="mt-2 small">
                                    {% for comp in relatorio.comprovativos.all %}
                                        <div class="d-flex align-items-center justify-content-between border-bottom py-1">
                                            <a href="{{ comp.arquivo.url }}" target="_blank" class="text-decoration-none text-primary">
                                                <i class="fas fa-paperclip me-1"></i>
                                                {{ comp.arquivo.name|slice:"-30:" }}
                                            </a>
                                            <!-- remover: atualize a URL/a√ß√£o conforme sua view -->
                                            <a href="#" class="text-danger small" title="Remover"
                                               onclick="return confirm('Remover este comprovativo?');">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    {% empty %}
                                        <span class="text-muted">Nenhum comprovativo anexado.</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <small class="text-muted">Nenhum comprovativo anexado.</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Descri√ß√£o do relat√≥rio (se quiser exibir) -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <label class="form-label small fw-bold">Observa√ß√µes do Relat√≥rio</label>
                            {{ relatorio_form.descricao }}
                            {% if relatorio_form.descricao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ relatorio_form.descricao.errors.as_text }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- manter sector/data no form, mas escondidos (para envio) -->
                    <div class="d-none">
                        {{ relatorio_form.sector }}
                        {{ relatorio_form.data }}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endwith %}

        <!-- üîπ Mensagens -->
        {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- üîπ Registros de Autocarros (cada RegistoDiarioForm com prefix registro_ID) -->
        <div class="row">
            {% for item in forms %}
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0">
                            <i class="fas fa-bus me-2"></i>
                            {{ item.registro.autocarro.numero }} - {{ item.registro.autocarro.modelo }}
                        </h6>
                        <div>
                            {% if item.registro.validado %}
                                <span class="badge bg-success">Validado</span>
                            {% elif item.registro.concluido %}
                                <span class="badge bg-warning">Conclu√≠do</span>
                            {% else %}
                                <span class="badge bg-secondary">Pendente</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="resumo-card">
                            <div class="row text-center small">
                                <div class="col-4">
                                    <div class="text-success resumo-valor" id="entradas_total_{{ item.registro.id }}">0.00</div>
                                    <small>Entradas</small>
                                </div>
                                <div class="col-4">
                                    <div class="text-danger resumo-valor" id="saidas_total_{{ item.registro.id }}">0.00</div>
                                    <small>Sa√≠das</small>
                                </div>
                                <div class="col-4">
                                    <div class="resumo-valor" id="saldo_liquido_{{ item.registro.id }}">0.00</div>
                                    <small>Saldo</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="form-check">
                                    {{ item.form.concluido }}
                                    <label class="form-check-label small">Conclu√≠do</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    {{ item.form.validado }}
                                    <label class="form-check-label small">Validado</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12 mb-2">
                                <label class="form-label small fw-bold">Motorista</label>
                                {{ item.form.motorista }}
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small fw-bold">Cobrador Principal</label>
                                {{ item.form.cobrador_principal }}
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small fw-bold">Cobrador Auxiliar</label>
                                {{ item.form.cobrador_auxiliar }}
                            </div>
                        </div>

                        <!-- Entradas -->
                        <div class="entradas-card mb-3 p-2">
                            <h6 class="text-success mb-2 small">
                                <i class="fas fa-arrow-down me-1"></i>Entradas (Kz)
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.normal.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.normal }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.alunos.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.alunos }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.luvu.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.luvu }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.frete.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.frete }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sa√≠das -->
                        <div class="saidas-card mb-3 p-2">
                            <h6 class="text-danger mb-2 small">
                                <i class="fas fa-arrow-up me-1"></i>Sa√≠das (Kz)
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.alimentacao.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.alimentacao }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.parqueamento.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.parqueamento }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.taxa.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.taxa }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">{{ item.form.outros.label }}</label>
                                    <div class="input-group-custom">
                                        {{ item.form.outros }}
                                        <span class="currency-symbol">Kz</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-secondary mb-2 small">
                                <i class="fas fa-chart-bar me-1"></i>Dados Operacionais
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">N¬∫ de Viagens</label>
                                    {{ item.form.numero_viagens }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Km Percorridos</label>
                                    {{ item.form.km_percorridos }}
                                </div>
                            </div>
                        </div>

                        <!-- campo id escondido para o registro (se existir) -->
                        {{ item.form.id }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg me-2">
                <i class="fas fa-save me-2"></i>Salvar Altera√ß√µes
            </button>
            <a href="{% url 'listar_registros' %}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i>Cancelar
            </a>
        </div>
    </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getValue(id) {
        const el = document.getElementById(id);
        const v = parseFloat(el?.value || 0);
        return isNaN(v) ? 0 : v;
    }
    function formatNumber(value) { return value.toFixed(2); }

    function updateSummary(registroId) {
        const entradas = getValue(`id_registro_${registroId}-normal`) +
                         getValue(`id_registro_${registroId}-alunos`) +
                         getValue(`id_registro_${registroId}-luvu`) +
                         getValue(`id_registro_${registroId}-frete`);
        const saidas = getValue(`id_registro_${registroId}-alimentacao`) +
                       getValue(`id_registro_${registroId}-parqueamento`) +
                       getValue(`id_registro_${registroId}-taxa`) +
                       getValue(`id_registro_${registroId}-outros`);
        const saldo = entradas - saidas;

        document.getElementById(`entradas_total_${registroId}`).textContent = formatNumber(entradas);
        document.getElementById(`saidas_total_${registroId}`).textContent = formatNumber(saidas);
        const saldoEl = document.getElementById(`saldo_liquido_${registroId}`);
        saldoEl.textContent = formatNumber(saldo);
        saldoEl.className = saldo < 0 ? 'text-danger resumo-valor' :
                            saldo > 0 ? 'text-success resumo-valor' : 'resumo-valor';
    }

    {% for item in forms %}
    (() => {
        const id = {{ item.registro.id }};
        const campos = ['normal','alunos','luvu','frete','alimentacao','parqueamento','taxa','outros'];
        campos.forEach(c => {
            const el = document.getElementById(`id_registro_${id}-${c}`);
            if (el) {
                el.addEventListener('input', () => updateSummary(id));
                el.classList.add('numeric-input');
            }
        });
        updateSummary(id);
    })();
    {% endfor %}
});
</script>
{% endblock %}
