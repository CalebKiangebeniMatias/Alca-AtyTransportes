{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="card p-3">
    <h4>{{ manut|default_if_none:"Agendar Manutenção" }}</h4>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Sector</label>
          {{ form.sector }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Autocarro</label>
          {{ form.autocarro }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Data Última</label>
          {{ form.data_ultima }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Km Última</label>
          {{ form.km_ultima }}
        </div>
        <div class="col-12">
          {{ form.observacao }}
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-primary">Salvar</button>
        <a class="btn btn-secondary" href="{% url 'manutencao_list' %}">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const sectorSelect = document.getElementById('id_sector_select');
  const autSelect = document.getElementById('id_autocarro_select');
  if (!sectorSelect || !autSelect) return;

  async function carregarAutocarros(sectorId){
    autSelect.innerHTML = '<option value="">Carregando...</option>';
    try{
      const url = "{% url 'api_autocarros_por_sector' %}" + '?sector_id=' + encodeURIComponent(sectorId);
      const resp = await fetch(url, { credentials: 'same-origin' });
      const data = await resp.json();
      autSelect.innerHTML = '<option value="">-- Selecionar --</option>';
      if (data.ok && Array.isArray(data.autocarros)){
        data.autocarros.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.numero + (a.modelo ? ' — ' + a.modelo : '');
          autSelect.appendChild(opt);
        });
      }
    }catch(err){
      autSelect.innerHTML = '<option value="">Erro ao carregar</option>';
      console.error(err);
    }
  }

  sectorSelect.addEventListener('change', function(){
    const sid = this.value;
    if (sid) carregarAutocarros(sid);
    else autSelect.innerHTML = '<option value="">-- Selecionar --</option>';
  });

  // Se já existir sector selecionado no form, carregar autos ao abrir
  if (sectorSelect.value) carregarAutocarros(sectorSelect.value);
});
</script>
{% endblock %}