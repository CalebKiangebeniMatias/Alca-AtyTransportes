{% extends 'base.html' %}
{% load l10n %}
{% load humanize %}

{% block title %}Dashboard - Sistema de Autocarros{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container-fluid py-4 fade-in">

    <!-- üîé Filtro -->
    <div class="row mb-4 align-items-end">
        <div class="col-md-4">
            <form method="get" class="row g-2">
                <div class="col-md-8">
                    <label for="mes" class="form-label text-light">Selecionar M√™s/Ano</label>
                    <input type="month" name="mes" id="mes" value="{{ mes }}" class="form-control shadow-sm bg-dark text-light border-secondary">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100 shadow-sm">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üìà Painel Gr√°ficos -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="chart-card">
                <h6 class="text-light">Entradas</h6>
                <canvas id="chartEntradas" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-card">
                <h6 class="text-light">Despesas</h6>
                <canvas id="chartDespesas" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-card">
                <h6 class="text-light">Saldo</h6>
                <canvas id="chartSaldo" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- üìä Resumo Geral -->
    <h4 class="section-title text-light mb-3">Resumo Geral</h4>
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card stats-card bg-success-gradient">
                <i class="fas fa-coins icon"></i>
                <h5 class="mb-1">Entradas</h5>
                <p class="display-6 fw-bold mb-0">{{ total_entradas|floatformat:2 }} Kz</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-danger-gradient">
                <i class="fas fa-money-bill-wave icon"></i>
                <h5 class="mb-1">Despesas</h5>
                <p class="display-6 fw-bold mb-0">{{ total_saidas|floatformat:2 }} Kz</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-warning-gradient text-dark">
                <i class="fas fa-piggy-bank icon"></i>
                <h5 class="mb-1">Saldo</h5>
                <p class="display-6 fw-bold mb-0">{{ total_resto|floatformat:2 }} Kz</p>
            </div>
        </div>
    </div>

    <!-- üöç Estat√≠sticas por Autocarro -->
    <h4 class="section-title text-light mb-3">Estat√≠sticas por Autocarro</h4>
    <div class="row g-4">
        {% with melhor=autocarros_stats|dictsortreversed:"resto"|first %}
        {% for stats in autocarros_stats|dictsort:"resto" %}
        <div class="col-md-4 col-sm-6">
            <div class="card autocarro-card {% if stats.resto == melhor.resto %} destaque-verde {% elif stats.resto >= 500000 %} destaque-laranja {% elif stats.resto > 0 %} destaque-amarelo {% else %} destaque-vermelho {% endif %}">
                <div class="card-body">
                    <div class="bus-icon">
                        <i class="fas fa-bus fa-2x"></i>
                        {% if stats.resto == melhor.resto %}
                        <span class="badge bg-success position-absolute top-0 end-0 m-2">Melhor</span>
                        {% endif %}
                    </div>
                    <h5 class="mb-0">{{ stats.autocarro.numero }}</h5>
                    <p class="text-light text-opacity-75 small mb-3">{{ stats.autocarro.modelo }}</p>
                    <div class="stats-grid">
                        <div><span>KMs</span> <strong>{{ stats.total_km|floatformat:2 }}</strong></div>
                        <div><span>Entradas</span> <strong>{{ stats.total_entradas|floatformat:2 }}</strong></div>
                        <div><span>Despesas</span> <strong>{{ stats.total_saidas|floatformat:2 }}</strong></div>
                        <div><span>Saldo</span> <strong>{{ stats.resto|floatformat:2 }}</strong></div>
                        <div><span>Passageiros</span> <strong>{{ stats.total_passageiros|intcomma }}</strong></div>
                        <div><span>Viagens</span> <strong>{{ stats.total_viagens|intcomma }}</strong></div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 text-center">
                    <a href="{% url 'detalhe_autocarro' stats.autocarro.id %}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-eye"></i> Detalhes
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endwith %}
    </div>

    <!-- ‚öôÔ∏è Bot√µes -->
    <div class="text-center mt-5">
        <a href="{% url 'adicionar_relatorio_sector' %}" class="btn btn-primary btn-action me-2">
            <i class="fas fa-plus me-1"></i> Adicionar Relat√≥rio
        </a>
        <a href="{% url 'exportar_relatorio_dashboard' %}?mes={{ mes }}" class="btn btn-success btn-action">
            <i class="fas fa-file-word"></i> Gerar Relat√≥rio (Word)
        </a>
    </div>
</div>

<style>
    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --text-light: #f8fafc;
        --text-muted: rgba(255,255,255,0.6);
        --radius: 16px;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-dark);
    }

    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .chart-card {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .stats-card {
        text-align: center;
        border-radius: var(--radius);
        padding: 25px;
        color: #fff;
        transition: 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    .icon {
        font-size: 2.2rem;
        margin-bottom: 10px;
    }

    .bg-success-gradient { background: linear-gradient(135deg, #22c55e, #15803d); }
    .bg-danger-gradient { background: linear-gradient(135deg, #ef4444, #991b1b); }
    .bg-warning-gradient { background: linear-gradient(135deg, #facc15, #eab308); color: #111; }

    .autocarro-card {
        border: none;
        border-radius: var(--radius);
        transition: 0.3s;
        color: white;
    }

    .autocarro-card:hover { transform: translateY(-4px); }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 0.9rem;
    }

    .btn-action {
        border-radius: 30px;
        padding: 10px 25px;
        font-weight: 600;
        transition: 0.3s;
    }

    .btn-action:hover { transform: translateY(-2px); }

    .destaque-verde { background: linear-gradient(135deg, #16a34a, #15803d); }
    .destaque-laranja { background: linear-gradient(135deg, #ea580c, #c2410c); }
    .destaque-amarelo { background: linear-gradient(135deg, #facc15, #eab308); color: #222; }
    .destaque-vermelho { background: linear-gradient(135deg, #ef4444, #b91c1c); }
</style>

<!-- üìä Chart.js Script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const entradas = {{ entradas_por_dia|safe }};
    const despesas = {{ despesas_por_dia|safe }};
    const saldo = {{ saldo_por_dia|safe }};
    const labels = {{ dias_labels|safe }};

    const baseConfig = (color1, color2, data) => ({
        type: 'line',
        data: { labels, datasets: [{ data, borderColor: color1, backgroundColor: color2, fill: true, tension: 0.4 }] },
        options: {
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } },
            elements: { point: { radius: 0 } },
            animation: { duration: 1200, easing: 'easeOutCubic' },
        }
    });

    new Chart(document.getElementById('chartEntradas'), baseConfig('#22c55e', 'rgba(34,197,94,0.2)', entradas));
    new Chart(document.getElementById('chartDespesas'), baseConfig('#ef4444', 'rgba(239,68,68,0.2)', despesas));
    new Chart(document.getElementById('chartSaldo'), baseConfig('#facc15', 'rgba(250,204,21,0.2)', saldo));
});
</script>

{% endblock %}
