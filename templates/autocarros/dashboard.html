{% extends 'base.html' %}
{% load l10n %}
{% load humanize %}

{% block title %}Dashboard - Sistema de Autocarros{% endblock %}

{% block content %}
    <style>
        /* 隼 Botﾃ｣o moderno em gradiente */
        .btn-gradient {
            background: linear-gradient(135deg, #2b7a2b, #3cc13c);
            color: #fff !important;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #3cc13c, #2b7a2b);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 128, 0, 0.3);
        }

        /* ﾃ皇one animado */
        .btn-gradient i {
            transition: transform 0.3s ease;
        }

        .btn-gradient:hover i {
            transform: rotate(-10deg) scale(1.1);
        }
    </style>

    <!-- 博 Filtro de Ano e Mﾃｪs -->
    <div class="row mb-4">
        <div class="col-md-4">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-8">
                    <label for="mes" class="form-label text-white">Selecionar Mﾃｪs/Ano</label>
                    <input type="month" name="mes" id="mes" value="{{ mes }}" class="form-control">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumo Geral (com toggle para despesas variﾃ｡veis) -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <!-- container de valores brutos para o JS -->
            <div id="resumo_values"
                 data-entradas="{{ total_entradas }}"
                 data-saidas="{{ total_saidas }}"
                 data-despesas="{{ total_despesa2_1 }}"
                 data-lucro="{{ total_lucro }}"
                 data-saldo="{{ total_resto }}"
            ></div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-coins icon-stat text-success"></i>
                    <div class="stats-number">
                        {% localize on %}<strong id="display_entradas">{{ total_entradas|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Entradas</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-money-bill-wave icon-stat text-danger"></i>
                    <div class="stats-number text-danger">
                        {% localize on %}<strong id="display_saidas">{{ total_saidas|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Saﾃｭdas</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-piggy-bank icon-stat text-warning"></i>
                    <div class="stats-number text-warning">
                        {% localize on %}<strong id="display_saldo">{{ total_resto|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Saldo</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4 bg-azul-forte">
        <div class="card-body">
            <h5 class="text-white text-center mb-3">Grﾃ｡fico de Resumo Da Produﾃｧﾃ｣o</h5>
            <canvas id="graficoResumo" height="90"></canvas>
        </div>
    </div>

    <div class="card shadow mb-4 bg-azul-forte">
        <div class="card-body">
            <h5 class="text-white text-center mb-3">Grﾃ｡fico de Resumo De Lucro</h5>
            <canvas id="graficoLucro" height="90"></canvas>
        </div>
    </div>
    
    <!-- Cards Estatﾃｭsticas por Autocarro -->
    <div class="row mb-4">
        {% for stats in autocarros_stats %}
            <div class="col-md-4 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm bg-azul-forte">
                    <div class="card-body text-center">
                        <!-- Grﾃ｡fico individual por autocarro -->
                        <div style="height:180px;">
                            <canvas id="chart-{{ stats.autocarro.id }}"></canvas>
                        </div>

                        <i class="fas fa-bus fa-2x mb-2 text-primary"></i>
                        <h5 class="card-title">{{ stats.autocarro.numero }}</h5>
                        <p class="text-muted">{{ stats.autocarro.modelo }}</p>
                        
                        <p><strong>KMs:</strong> {% localize on %}{{ stats.total_km|floatformat:2 }}{% endlocalize %} km</p>
                        <p class="text-success">
                            <strong>Entradas:</strong> {% localize on %}{{ stats.total_entradas|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        <p class="text-danger">
                            <strong>Outras Despesas:</strong> {% localize on %}{{ stats.total_saidas|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        {% if stats.total_combustivel %}
                        <p class="text-danger">
                            <strong>Combustﾃｭvel:</strong> {% localize on %}{{ stats.total_combustivel|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        {% endif %}
                        <p class="{% if stats.resto >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <strong>Saldo:</strong> {% localize on %}{{ stats.resto|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        <p><strong>Passageiros:</strong> {{ stats.total_passageiros|intcomma }}</p>
                        <p><strong>Viagens:</strong> {{ stats.total_viagens|intcomma }}</p>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{% url 'detalhe_autocarro' stats.autocarro.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Detalhes
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="text-center mt-4">
        <a href="{% url 'adicionar_relatorio_sector' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Adicionar Relatﾃｳrio por Sector
        </a>
    </div>

    <!-- Botﾃ｣o para gerar relatﾃｳrio detalhado em PDF -->
    <div class="text-center mt-4">
        <a id="btn_export_relatorio" href="{% url 'exportar_relatorio_dashboard' %}?mes={{ mes }}" 
            class="btn btn-gradient shadow-lg px-5 py-3 d-inline-flex align-items-center gap-2">
            <i class="fas fa-file-word fa-lg"></i>
            <span>Gerar Relatﾃｳrio (Word)</span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script para o grﾃ｡fico de PRODUﾃﾃグ (cores diferentes) -->
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            // 隼 1. PEGAR O CANVAS
            const canvas = document.getElementById('graficoResumo');
            if (!canvas) {
                console.error('Canvas graficoResumo nﾃ｣o encontrado!');
                return;
            }

            // 隼 2. PEGAR O CONTAINER COM OS DADOS
            const container = document.getElementById('resumo_values');
            if (!container) {
                console.error('Container resumo_values nﾃ｣o encontrado!');
                return;
            }

            // 隼 3. FUNﾃﾃグ PARA CONVERTER VALORES
            function toNumberRaw(v){
                if (v === undefined || v === null) return 0;
                const s = String(v).trim();
                if (s === '') return 0;
                // Remove pontos de milhar e troca vﾃｭrgula por ponto
                const normalized = s.replace(/\./g, '').replace(',', '.');
                const n = Number(normalized);
                return isNaN(n) ? 0 : n;
            }

            // 隼 4. EXTRAIR OS VALORES
            const entradas = toNumberRaw(container.dataset.entradas);
            const saidas   = toNumberRaw(container.dataset.saidas);
            const saldo    = toNumberRaw(container.dataset.saldo);

            console.log('Valores do grﾃ｡fico de Produﾃｧﾃ｣o:', { entradas, saidas, saldo });

            // 隼 5. CRIAR O GRﾃ：ICO COM CORES DIFERENTES
            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Saﾃｭdas', 'Saldo'],
                    datasets: [{
                        data: [entradas, saidas, saldo],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',    // verde para Entradas
                            'rgba(220, 53, 69, 0.7)',    // vermelho para Saﾃｭdas
                            'rgba(184, 181, 23, 0.7)'    // azul ciano para Saldo
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(224, 221, 4, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('pt-PT') + ' Kz';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                callback: function(value){
                                    return value.toLocaleString('pt-PT') + ' Kz';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        });
    </script>

    <!-- GRﾃ：ICO DE LUCRO (cores diferentes) -->
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            // 隼 1. PEGAR O CANVAS
            const canvas = document.getElementById('graficoLucro');
            if (!canvas) {
                console.error('Canvas graficoLucro nﾃ｣o encontrado!');
                return;
            }

            // 隼 2. PEGAR O CONTAINER COM OS DADOS
            const container = document.getElementById('resumo_values');
            if (!container) {
                console.error('Container resumo_values nﾃ｣o encontrado!');
                return;
            }

            // 隼 3. FUNﾃﾃグ PARA CONVERTER VALORES
            function toNumberRaw(v){
                if (v === undefined || v === null) return 0;
                const s = String(v).trim();
                if (s === '') return 0;
                // Remove pontos de milhar e troca vﾃｭrgula por ponto
                const normalized = s.replace(/\./g, '').replace(',', '.');
                const n = Number(normalized);
                return isNaN(n) ? 0 : n;
            }

            // 隼 4. EXTRAIR OS VALORES
            const saldo = toNumberRaw(container.dataset.saldo);
            const despesas  = toNumberRaw(container.dataset.despesas);
            const lucro    = toNumberRaw(container.dataset.lucro);

            console.log('Valores do grﾃ｡fico de Lucro:', { saldo, despesas, lucro });

            // 隼 5. CRIAR O GRﾃ：ICO COM CORES DIFERENTES
            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['Saldo', 'Despesas', 'Lucro'],
                    datasets: [{
                        data: [saldo, despesas, lucro],
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.7)',    // amarelo/dourado para Saldo
                            'rgba(253, 126, 20, 0.7)',   // laranja para Despesas
                            lucro >= 0 ? 'rgba(81, 193, 66, 0.7)' : 'rgba(255, 69, 69, 0.7)'    // verde para Lucro positivo, vermelho para negativo
                        ],
                        borderColor: [
                            'rgba(255, 193, 7, 1)',
                            'rgba(231, 37, 37, 1)',
                            lucro >= 0 ? 'rgba(81, 193, 66, 1)' : 'rgba(255, 69, 69, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('pt-PT') + ' Kz';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                callback: function(value){
                                    return value.toLocaleString('pt-PT') + ' Kz';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        });
    </script>

    <!-- Grﾃ｡ficos individuais por autocarro (CORRIGIDO com localize off) -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            {% for stats in autocarros_stats %}
            {% localize off %}
            new Chart(document.getElementById("chart-{{ stats.autocarro.id }}"), {
                type: 'doughnut',
                data: {
                    labels: ['Entradas', 'Despesas', 'Saldo'],
                    datasets: [{
                        data: [
                            {{ stats.total_entradas|default:0 }},
                            {{ stats.total_saidas|default:0 }},
                            {{ stats.resto|default:0 }}
                        ],
                        backgroundColor: [
                            '#28a745',  // Verde para Entradas
                            '#dc3545',  // Vermelho para Despesas
                            '#ffbb00ff'   // Azul ciano para Saldo
                        ],
                        borderWidth: 2,
                        borderColor: '#1a1a2e'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toLocaleString('pt-PT') + ' Kz';
                                }
                            }
                        }
                    }
                }
            });
            {% endlocalize %}
            {% endfor %}
        });
    </script>


{% endblock %}

