{% extends 'base.html' %}
{% load l10n %}
{% load humanize %}

{% block title %}Dashboard - Sistema de Autocarros{% endblock %}

{% block content %}
    <style>
        /* üîπ Bot√£o moderno em gradiente */
        .btn-gradient {
            background: linear-gradient(135deg, #2b7a2b, #3cc13c);
            color: #fff !important;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #3cc13c, #2b7a2b);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 128, 0, 0.3);
        }

        /* √çcone animado */
        .btn-gradient i {
            transition: transform 0.3s ease;
        }

        .btn-gradient:hover i {
            transform: rotate(-10deg) scale(1.1);
        }
    </style>

    <!-- üîé Filtro de Ano e M√™s -->
    <div class="row mb-4">
        <div class="col-md-4">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-8">
                    <label for="mes" class="form-label text-white">Selecionar M√™s/Ano</label>
                    <input type="month" name="mes" id="mes" value="{{ mes }}" class="form-control">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumo Geral (com toggle para despesas vari√°veis) -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <!-- container de valores brutos para o JS -->
            <div id="resumo_values"
                 data-entradas="{{ total_entradas }}"
                 data-saidas="{{ total_saidas }}"
                 data-variaveis="{{ total_variaveis }}"
                 data-saldo="{{ total_resto }}"
            ></div>

            <div class="d-flex justify-content-end align-items-center mb-2">
                <div class="form-check form-switch me-3">
                    <!-- Removido 'checked' para ocultar por padr√£o -->
                    <input class="form-check-input" type="checkbox" id="toggle_variaveis">
                    <label class="form-check-label small" for="toggle_variaveis">Mostrar despesas vari√°veis</label>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-coins icon-stat text-success"></i>
                    <div class="stats-number">
                        {% localize on %}<strong id="display_entradas">{{ total_entradas|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Entradas</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-money-bill-wave icon-stat text-danger"></i>
                    <div class="stats-number text-danger">
                        {% localize on %}<strong id="display_saidas">{{ total_saidas|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Despesas</h5>
                    <div class="small text-muted mt-2" id="info_variaveis">(inclui vari√°veis: <span id="display_variaveis">{{ total_variaveis|floatformat:2 }}</span>)</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-piggy-bank icon-stat text-warning"></i>
                    <div class="stats-number text-warning">
                        {% localize on %}<strong id="display_saldo">{{ total_resto|floatformat:2 }}{% endlocalize %} Kz</strong>
                    </div>
                    <h5 class="card-title">Saldo</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Combust√≠vel -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-gas-pump icon-stat text-danger"></i>
                    <div class="stats-number text-danger">{% localize on %}{{ total_combustivel_valor|floatformat:2 }}{% endlocalize %} Kz</div>
                    <h5 class="card-title">Combust√≠vel</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-tint icon-stat text-info"></i>
                    <div class="stats-number text-info">{% localize on %}{{ total_combustivel_litros|floatformat:2 }}{% endlocalize %}</div>
                    <h5 class="card-title">Por Litros (ilustr.)</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-filter icon-stat text-warning"></i>
                    <div class="stats-number text-warning">{% localize on %}{{ total_combustivel_sobragem|floatformat:2 }}{% endlocalize %} Kz</div>
                    <h5 class="card-title">Sopragem De Filtros</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center bg-azul-forte">
                <div class="card-body">
                    <i class="fas fa-bucket icon-stat text-info"></i>
                    <div class="stats-number text-info">{% localize on %}{{ total_combustivel_lavagem|floatformat:2 }}{% endlocalize %} Kz</div>
                    <h5 class="card-title">Lavagem</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards Estat√≠sticas por Autocarro -->
    <div class="row mb-4">
        {% for stats in autocarros_stats %}
            <div class="col-md-4 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm bg-azul-forte">
                    <div class="card-body text-center">
                        <i class="fas fa-bus fa-2x mb-2 text-primary"></i>
                        <h5 class="card-title">{{ stats.autocarro.numero }}</h5>
                        <p class="text-muted">{{ stats.autocarro.modelo }}</p>
                        
                        <p><strong>KMs:</strong> {% localize on %}{{ stats.total_km|floatformat:2 }}{% endlocalize %} km</p>
                        <p class="text-success">
                            <strong>Entradas:</strong> {% localize on %}{{ stats.total_entradas|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        <p class="text-danger">
                            <strong>Despesas:</strong> {% localize on %}{{ stats.total_saidas|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        {% if stats.total_combustivel %}
                        <p class="text-danger">
                            <strong>Combust√≠vel:</strong> {% localize on %}{{ stats.total_combustivel|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        {% endif %}
                        <p class="{% if stats.resto >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <strong>Saldo:</strong> {% localize on %}{{ stats.resto|floatformat:2 }}{% endlocalize %} Kz
                        </p>
                        <p><strong>Passageiros:</strong> {{ stats.total_passageiros|intcomma }}</p>
                        <p><strong>Viagens:</strong> {{ stats.total_viagens|intcomma }}</p>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{% url 'detalhe_autocarro' stats.autocarro.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Detalhes
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="text-center mt-4">
        <a href="{% url 'adicionar_relatorio_sector' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Adicionar Relat√≥rio por Sector
        </a>
    </div>

    <!-- Bot√£o para gerar relat√≥rio detalhado em PDF -->
    <div class="text-center mt-4">
        <a id="btn_export_relatorio" href="{% url 'exportar_relatorio_dashboard' %}?mes={{ mes }}" 
            class="btn btn-gradient shadow-lg px-5 py-3 d-inline-flex align-items-center gap-2">
            <i class="fas fa-file-word fa-lg"></i>
            <span>Gerar Relat√≥rio Detalhado (Word)</span>
        </a>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const container = document.getElementById('resumo_values');
  function toNumberRaw(v){
    // tenta converter string do template para n√∫mero (considera ponto ou v√≠rgula)
    if (v === undefined || v === null) return 0;
    const s = String(v).trim();
    if (s === '') return 0;
    // remover milhares (ponto) e trocar v√≠rgula por ponto
    const normalized = s.replace(/\./g, '').replace(',', '.');
    const n = Number(normalized);
    return isNaN(n) ? 0 : n;
  }

  const entradas = toNumberRaw(container.dataset.entradas);
  const saidas = toNumberRaw(container.dataset.saidas);
  const variaveis = toNumberRaw(container.dataset.variaveis);
  // saldo bruto (j√° calculado no servidor)
  const saldo = toNumberRaw(container.dataset.saldo);

  const toggle = document.getElementById('toggle_variaveis');
  const elSaidas = document.getElementById('display_saidas');
  const elVariaveis = document.getElementById('display_variaveis');
  const elSaldo = document.getElementById('display_saldo');
  const elEntradas = document.getElementById('display_entradas');

  function fmtMoney(v){
    try{
      const n = Number(v) || 0;
      return n.toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' Kz';
    }catch(e){ return String(v); }
  }

  function atualizar(){
    const mostrar = toggle.checked;
    const saidasAtuais = mostrar ? saidas : (saidas - variaveis);
    const saldoAtual = entradas - saidasAtuais;

    elEntradas.textContent = fmtMoney(entradas);
    elSaidas.textContent = fmtMoney(saidasAtuais);
    elVariaveis.textContent = (variaveis ? (variaveis.toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' Kz') : '0,00 Kz');
    elSaldo.textContent = fmtMoney(saldoAtual);

    if (saldoAtual < 0) elSaldo.style.color = '#c00'; else elSaldo.style.color = '';
  }

  toggle.addEventListener('change', atualizar);
  atualizar();

  // Interceptar exporta√ß√£o para controlar spinner e download
  const btnExport = document.getElementById('btn_export_relatorio');
  if (btnExport){
    btnExport.addEventListener('click', async function(ev){
      ev.preventDefault();
      const url = btnExport.href;
      // criar overlay spinner
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.left = 0; overlay.style.top = 0;
      overlay.style.width = '100%'; overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.35)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = 2000;
      overlay.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Carregando...</span></div>';
      document.body.appendChild(overlay);

      try {
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) throw new Error('Erro ao gerar relat√≥rio: ' + resp.status);
        const blob = await resp.blob();
        // obter filename do header Content-Disposition se existir
        const cd = resp.headers.get('Content-Disposition') || '';
        let filename = 'relatorio.docx';
        const m = cd.match(/filename\*?=['"]?(?:UTF-8'')?([^;'"]+)/i);
        if (m && m[1]) filename = decodeURIComponent(m[1]);

        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);
      } catch(err) {
        console.error(err);
        alert('Falha ao gerar/baixar relat√≥rio: ' + (err.message || err));
      } finally {
        // sempre remover o overlay para parar o loader
        overlay.remove();
      }
    });
  }
});
</script>
{% endblock %}
