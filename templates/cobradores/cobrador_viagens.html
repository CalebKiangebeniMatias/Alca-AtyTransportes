<!-- Página: Agenda de viagens por cobrador/autocarro -->
{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h5>Agenda de Viagens — Cobrador</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label for="input_autocarro" class="form-label">Número do Autocarro</label>
        <input id="input_autocarro" class="form-control" placeholder="Ex.: 123" />
        <div class="form-text">Informe o número do autocarro e pressione Enter.</div>
      </div>

      <ul class="nav nav-tabs" id="tabs" role="tablist" style="margin-bottom:1rem;">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-lancar" data-bs-toggle="tab" data-bs-target="#lancar" type="button">Lançar Viagem</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-resumo" data-bs-toggle="tab" data-bs-target="#resumo" type="button">Ver Viagens / Resumo</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="lancar">
          <form id="form_viagem" class="row g-3">
            <input type="hidden" id="autocarro_id" name="autocarro_id" />
            <div class="col-md-3">
              <label class="form-label">Data</label>
              <input type="date" id="viagem_data" class="form-control" value="{{ today|default:None }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Hora</label>
              <input type="time" id="viagem_hora" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Valor (Kz)</label>
              <input type="number" step="0.01" id="viagem_valor" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Passageiros</label>
              <input type="number" id="viagem_passageiros" class="form-control" />
            </div>
            <div class="col-12">
              <label class="form-label">Observação</label>
              <textarea id="viagem_obs" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12 text-end">
              <button type="button" id="btn_salvar_viagem" class="btn btn-primary mt-2">Salvar Viagem</button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="resumo">
          <div id="resumo_header" class="mb-3">
            <h6>Viagens do autocarro: <span id="resumo_autocarro">—</span></h6>
            <small class="text-muted">Total valor: <strong id="resumo_total_valor">0,00</strong> Kz — Total passageiros: <strong id="resumo_total_pass">0</strong></small>
          </div>
          <div id="tabela_viagens" class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Data</th><th>Hora</th><th>Valor (Kz)</th><th>Passageiros</th><th>Cobrador</th><th>Obs</th>
                  <th>Status</th><th>Ações</th>
                </tr>
              </thead>
              <tbody id="tbody_viagens"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1];

function fmt_money_br(valor){
  try{
    let v = Number(valor);
    if (isNaN(v)) return "0,00";
    const sign = v < 0 ? '-' : '';
    v = Math.abs(v).toFixed(2);
    let parts = v.split('.');
    let intPart = parts[0];
    let dec = parts[1];
    intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return sign + intPart + ',' + dec;
  }catch(e){ return "0,00"; }
}

async function fetchViagens(numero){
  const params = new URLSearchParams({autocarro_numero: numero});
  const res = await fetch('/autocarros/cobrador/viagens/list/?' + params.toString(), {credentials: 'same-origin'});
  if (!res.ok) return null;
  return res.json();
}

document.getElementById('input_autocarro').addEventListener('keypress', async function(e){
  if (e.key === 'Enter'){
    e.preventDefault();
    const numero = this.value.trim();
    if (!numero) return;
    const data = await fetchViagens(numero);
    if (!data || !data.ok){ alert('Autocarro não encontrado ou erro'); return; }
    // preencher id e cabeçalho
    document.getElementById('autocarro_id').value = data.autocarro.id;
    document.getElementById('resumo_autocarro').textContent = data.autocarro.numero + ' — ' + data.autocarro.modelo;
    // popular aba resumo
    populateResumo(data);
    // ir para aba lançar
    var tab = new bootstrap.Tab(document.querySelector('#tab-lancar'));
    tab.show();
  }
});

function populateResumo(data){
  const tbody = document.getElementById('tbody_viagens');
  tbody.innerHTML = '';
  (data.viagens || []).forEach(v=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${v.data}</td><td>${v.hora}</td><td>${fmt_money_br(v.valor)} kz</td><td>${v.passageiros}</td><td>${v.cobrador}</td><td>${v.observacao}</td><td>${v.status || '—'}</td><td>
      <button class="btn btn-sm btn-success" onclick="validateViagem(${v.id}, 'approve')">Aprovar</button>
      <button class="btn btn-sm btn-danger" onclick="validateViagem(${v.id}, 'reject')">Rejeitar</button>
    </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('resumo_total_valor').textContent = fmt_money_br(data.resumo.total_valor);
  document.getElementById('resumo_total_pass').textContent = data.resumo.total_passageiros;
}

document.getElementById('btn_salvar_viagem').addEventListener('click', async function(){
  const aut_num = document.getElementById('input_autocarro').value.trim();
  if (!aut_num){ alert('Informe o número do autocarro'); return; }
  const payload = {
    autocarro_numero: aut_num,
    data: document.getElementById('viagem_data').value || new Date().toISOString().slice(0,10),
    hora: document.getElementById('viagem_hora').value || '',
    valor: document.getElementById('viagem_valor').value || '0',
    passageiros: document.getElementById('viagem_passageiros').value || '0',
    observacao: document.getElementById('viagem_obs').value || ''
  };
  const res = await fetch('/autocarros/cobrador/viagens/save/', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!data.ok){ alert('Erro ao salvar: ' + (data.error||'')); return; }
  // atualizar lista e resumo automaticamente
  const lista = await fetchViagens(aut_num);
  if (lista && lista.ok) populateResumo(lista);
  // limpar formulário parcialmente
  document.getElementById('viagem_valor').value = '';
  document.getElementById('viagem_passageiros').value = '';
  document.getElementById('viagem_obs').value = '';
  // mudar para aba resumo
  var tab = new bootstrap.Tab(document.querySelector('#tab-resumo'));
  tab.show();
});

async function validateViagem(id, action){
  if (!confirm('Confirma ' + action + ' ?')) return;
  const payload = {id: id, action: action};
  const res = await fetch('/autocarros/cobrador/viagens/validate/action/', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!data.ok){ alert('Erro: ' + (data.error||'')); return; }
  // atualizar lista atual
  const aut_num = document.getElementById('input_autocarro').value.trim();
  if (aut_num){
    const lista = await fetchViagens(aut_num);
    if (lista && lista.ok) populateResumo(lista);
  }
}
</script>
{% endblock %}
