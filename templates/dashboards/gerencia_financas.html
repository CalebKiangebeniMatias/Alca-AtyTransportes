{% extends 'base.html' %}
{% load humanize %}
{% load l10n %}

{% block title %}Resumo Financeiro{% endblock %}

{% block content %}
<style>
.container { max-width:1100px; margin:18px auto; }
.selector-row { display:flex; gap:8px; align-items:center; margin-bottom:12px; justify-content:flex-end; }
.month-input { padding:8px 12px; border-radius:8px; border:1px solid #e6edf3; background:#fff; font-weight:600; }

.linha { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:18px; }
.bloco { padding:14px; border-radius:10px; color:#fff; box-shadow: 0 2px 6px rgba(2,6,23,0.06); min-height:92px; display:flex; flex-direction:column; justify-content:space-between; }
.bloco .titulo { font-weight:700; display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#fff; }
.bloco .valor { font-size:1.25rem; font-weight:800; margin-top:6px; color:#fff; }
.small-muted { font-size:0.8rem; opacity:0.95; color:rgba(255,255,255,0.95); }

/* cores requeridas */
.bg-entradas { background: linear-gradient(135deg,#059669,#10b981); }   /* verde */
.bg-saidas { background: linear-gradient(135deg,#b91c1c,#ef4444); }     /* vermelho */
.bg-combustivel { background: linear-gradient(135deg,#92400e,#f97316); } /* laranja-escuro */
.bg-sobragem { background: linear-gradient(135deg,#b45309,#f59e0b); }   /* ambar para sobragem/lavagem */
.bg-lavagem { background: linear-gradient(135deg,#c2410c,#fb923c); }    /* lavagens laranja */
.bg-saldo { background: linear-gradient(135deg,#f59e0b,#fbbf24); }      /* amarelo */
.bg-fixas { background: linear-gradient(135deg,#0369a1,#0ea5e9); }      /* azul */
.bg-variaveis { background: linear-gradient(135deg,#6b21a8,#8b5cf6); }   /* roxo */
.bg-lucro { background: linear-gradient(135deg,#c2410c,#f97316); }      /* laranja */

.icon { width:18px; height:18px; display:inline-block; vertical-align:middle; }

/* responsividade e pequenos ajustes */
@media (max-width:700px) {
  .linha { grid-template-columns: 1fr; }
}

.btn-primary {
  display:inline-flex; align-items:center; gap:8px;
  background:#0f172a; color:#fff; border:0; padding:8px 12px; border-radius:8px;
  cursor:pointer; font-weight:700;
}
.btn-download {
  background: linear-gradient(90deg,#0ea5e9,#0369a1);
  color:#fff; border:0; padding:8px 10px; border-radius:8px;
  display:inline-flex; align-items:center; gap:8px; cursor:pointer;
}
.btn-icon {
  width:18px; height:18px; display:inline-block;
}
</style>

<div class="container">

    <!-- Seletor de mês atualizado com botão de download -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <form method="get" style="margin:0;">
        <div class="selector-row">
            <label for="mes" style="color:#334155; font-weight:600; margin-right:8px;">Selecionar mês:</label>
            <input id="mes" name="mes" type="month" class="month-input" value="{{ request.GET.mes|default:'' }}">
            <button type="submit" class="btn-primary">Aplicar</button>
        </div>
      </form>

      <!-- botão de download — cria URL com ?mes=YYYY-MM&download=1 -->
      <button id="btn-download" class="btn-download" title="Baixar relatório deste mês">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Baixar relatório
      </button>
    </div>

    <!-- ENTRADAS (verde) -->
    <div class="linha">
        <div class="bloco bg-entradas">
            <div class="titulo">Normal</div>
            <div class="valor">{% localize on %}{{ serie_normal|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Último mês</div>
        </div>

        <div class="bloco bg-entradas">
            <div class="titulo">Alunos</div>
            <div class="valor">{% localize on %}{{ serie_alunos|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Último mês</div>
        </div>

        <div class="bloco bg-entradas">
            <div class="titulo">Luvu</div>
            <div class="valor">{% localize on %}{{ serie_luvu|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Último mês</div>
        </div>

        <div class="bloco bg-entradas">
            <div class="titulo">Frete / Outros</div>
            <div class="valor">{% localize on %}{{ serie_frete|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Último mês</div>
        </div>
    </div>

    <div class="linha" style="margin-bottom:8px;">
        <div class="bloco bg-entradas" style="grid-column: span 2;">
            <div class="titulo">Entradas Totais</div>
            <div class="valor">{% localize on %}{{ serie_entradas|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Soma das entradas (último mês)</div>
        </div>
    </div>

    <!-- SAÍDAS: primeira linha alimentacao, taxas, outros, parqueamento -->
    <div class="linha">
        <div class="bloco bg-saidas">
            <div class="titulo">Alimentação</div>
            <div class="valor">{% localize on %}{{ serie_alimentacao|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Registro</div>
        </div>

        <div class="bloco bg-saidas">
            <div class="titulo">Taxas</div>
            <div class="valor">{% localize on %}{{ serie_taxa|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Registro</div>
        </div>

        <div class="bloco bg-saidas">
            <div class="titulo">Outros</div>
            <div class="valor">{% localize on %}{{ serie_outros|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Registro</div>
        </div>

        <div class="bloco bg-saidas">
            <div class="titulo">Parqueamento</div>
            <div class="valor">{% localize on %}{{ serie_parqueamento|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Registro</div>
        </div>
    </div>

    <!-- SAÍDAS: segunda linha Despesas Extra, Combustível, Lavagem, Sobragem -->
    <div class="linha">
        <div class="bloco bg-saidas">
            <div class="titulo">Despesas Extra (Relatórios)</div>
            <div class="valor">{% localize on %}{{ serie_despesas_extra|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Despesa geral por sector</div>
        </div>

        <div class="bloco bg-combustivel">
            <div class="titulo">Combustível (valor)</div>
            <div class="valor">{% localize on %}{{ serie_combustivel_valor|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Total combustível</div>
        </div>

        <div class="bloco bg-lavagem">
            <div class="titulo">Lavagem</div>
            <div class="valor">{% localize on %}{{ serie_combustivel_lavagem|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Lavagem</div>
        </div>

        <div class="bloco bg-sobragem">
            <div class="titulo">Sopragem / Filtros</div>
            <div class="valor">{% localize on %}{{ serie_combustivel_sobragem|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Sobragem / Filtros</div>
        </div>
    </div>

    <!-- linha só com Saldo -->
    <div class="linha" style="margin-bottom:8px;">
        <div class="bloco bg-saldo" style="grid-column: 1 / -1;">
            <div class="titulo">Saldo (Entradas - Saídas)</div>
            <div class="valor">{% localize on %}{{ serie_saldo|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Saldo do mês</div>
        </div>
    </div>

    <!-- Despesas fixas e variaveis (uma linha) -->
    <div class="linha">
        <div class="bloco bg-fixas">
            <div class="titulo">Despesas Fixas (Total)</div>
            <div class="valor">{% localize on %}{{ serie_total_despesas_fixas|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Usado no cálculo do lucro</div>
        </div>

        <div class="bloco bg-variaveis">
            <div class="titulo">Despesas Variáveis (Total)</div>
            <div class="valor">{% localize on %}{{ serie_despesas_variaveis|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Usado no cálculo do lucro</div>
        </div>
    </div>

    <!-- linha do Lucro -->
    <div class="linha" style="margin-top:12px;">
        <div class="bloco bg-lucro" style="grid-column: 1 / -1;">
            <div class="titulo">Lucro Final</div>
            <div class="valor">{% localize on %}{{ serie_lucro|last|default:0|floatformat:2 }}{% endlocalize %} Kz</div>
            <div class="small-muted">Saldo menos despesas fixas e variáveis</div>
        </div>
    </div>

</div>

<script>
(function(){
  const btn = document.getElementById('btn-download');
  if (!btn) return;
  btn.addEventListener('click', function(){
    const mesInput = document.getElementById('mes');
    const mes = mesInput && mesInput.value ? mesInput.value : '';
    const params = new URLSearchParams(window.location.search);
    if (mes) params.set('mes', mes);
    params.set('download', '1');
    // redireciona para a mesma view — implemente no servidor a resposta quando download=1
    window.location.href = window.location.pathname + '?' + params.toString();
  });
})();
</script>
{% endblock %}
