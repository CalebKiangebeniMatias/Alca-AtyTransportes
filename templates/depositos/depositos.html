{% extends 'base.html' %}
{% block content %}
  <div class="container mt-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Depósitos por Sector</h5>
        <small class="text-muted">Registre e consulte depósitos</small>
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs" id="tabs-dep">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-reg">Registrar</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-list">Listar</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-total">Totais</button></li>
        </ul>

        <div class="tab-content mt-3">
          <!-- Registrar -->
          <div class="tab-pane fade show active" id="tab-reg">
            <form id="form_deposito" class="row g-3" onsubmit="return false;">
              {% csrf_token %}
              <div class="col-md-4">
                <label class="form-label">Sector</label>
                <select id="dep_sector" class="form-select">
                  <option value="">-- Escolha sector --</option>
                  {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Data</label>
                <input id="dep_data" type="date" class="form-control" value="{{ now|date:'Y-m-d' }}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Valor</label>
                <input id="dep_valor" type="number" step="0.01" class="form-control" placeholder="0.00">
              </div>
              <div class="col-md-12">
                <label class="form-label">Observação</label>
                <textarea id="dep_obs" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-12 text-end">
                <button id="btn_dep_save" class="btn btn-primary">Salvar Depósito</button>
              </div>
            </form>
          </div>

          <!-- Listar -->
          <div class="tab-pane fade" id="tab-list">
            <div class="mb-2 d-flex gap-2">
              <select id="filter_sector" class="form-select w-auto">
                <option value="">Todos sectores</option>
                {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
              </select>
              <button id="btn_reload" class="btn btn-outline-primary">Recarregar</button>
            </div>
            <div id="lista_depositos" style="max-height:420px; overflow:auto"></div>
          </div>

          <!-- Totais -->
          <div class="tab-pane fade" id="tab-total">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Sector</label>
                <select id="total_sector" class="form-select">
                  <option value="">Todos sectores</option>
                  {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Total de Depósitos</label>
                <div class="h4" id="total_valor">0.00</div>
              </div>
              <div class="col-md-4 text-end">
                <button id="btn_total_reload" class="btn btn-outline-primary mt-4">Atualizar</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Depósito -->
  <div class="modal fade" id="modalEditarDeposito" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="form_edit_deposito" class="modal-content" onsubmit="return false;">
        <div class="modal-header">
          <h5 class="modal-title">Editar Depósito</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit_id">
          <div class="mb-2">
            <label class="form-label">Sector</label>
            <select id="edit_sector" class="form-select">
              <option value="">-- Escolha sector --</option>
              {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Data</label>
            <input id="edit_data" type="date" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Valor</label>
            <input id="edit_valor" type="number" step="0.01" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Observação</label>
            <textarea id="edit_obs" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btn_edit_save" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop() || '';
      const saveUrl = "{% url 'depositos_save' %}";
      const listUrl = "{% url 'depositos_list' %}";
      const detailUrlTemplate = "{% url 'depositos_detail' 0 %}"; // replace /0/ with /{id}/
      const editUrlTemplate = "{% url 'depositos_edit' 0 %}";     // replace /0/ with /{id}/
      const deleteUrl = "{% url 'depositos_delete' %}";

      function detailUrlFor(id){ return detailUrlTemplate.replace('/0/','/'+id+'/'); }
      function editUrlFor(id){ return editUrlTemplate.replace('/0/','/'+id+'/edit/').replace('/0/edit/','/'+id+'/edit/'); }

      // salvar
      document.getElementById('btn_dep_save').addEventListener('click', async function(e){
        e.preventDefault();
        const sector = document.getElementById('dep_sector').value;
        const data = document.getElementById('dep_data').value;
        const valor = document.getElementById('dep_valor').value;
        const obs = document.getElementById('dep_obs').value;
        if (!sector || !valor){ alert('Sector e valor são obrigatórios'); return; }
        const payload = {sector_id: parseInt(sector), data_deposito: data, valor: valor, observacao: obs};
        const res = await fetch(saveUrl, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
          body: JSON.stringify(payload)
        });
        if (!res.ok){ alert('Erro ao salvar'); return; }
        const r = await res.json();
        if (!r.ok){ alert(r.error || 'Erro'); return; }
        alert('Depósito salvo');
        document.getElementById('dep_valor').value = '';
        document.getElementById('dep_obs').value = '';
        carregarLista(); carregarTotal();
      });

      // listar
      async function carregarLista(sec=null){
        const url = listUrl + (sec ? ('?sector_id=' + sec) : '');
        const res = await fetch(url, {credentials:'same-origin'});
        if (!res.ok) return;
        const data = await res.json();
        if (!data.ok) return;
        const div = document.getElementById('lista_depositos');
        div.innerHTML = '';
        data.depositos.forEach(d=>{
          const el = document.createElement('div');
          el.className = 'border rounded p-2 mb-2 bg-light text-dark';
          const dataText = d.data_deposito ? d.data_deposito : '—';
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${d.sector}</strong> — ${dataText}
                <div class="small text-muted">${d.observacao || ''}</div>
              </div>
              <div class="text-end">
                <div class="text-success h6">${parseFloat(d.valor).toFixed(2)}</div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${d.id}">Editar</button>
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${d.id}">Eliminar</button>
                </div>
              </div>
            </div>`;
          div.appendChild(el);
        });
      }

      document.getElementById('btn_reload').addEventListener('click', async function(){
        const sec = document.getElementById('filter_sector').value;
        await carregarLista(sec || null);
      });

      // totais
      async function carregarTotal(sec=null){
        const url = listUrl + (sec ? ('?sector_id=' + sec) : '');
        const res = await fetch(url, {credentials:'same-origin'});
        if (!res.ok) return;
        const data = await res.json();
        if (!data.ok) return;
        document.getElementById('total_valor').textContent = parseFloat(data.total || 0).toFixed(2);
      }

      document.getElementById('btn_total_reload').addEventListener('click', async function(){
        const sec = document.getElementById('total_sector').value || null;
        await carregarTotal(sec);
      });

      // Delegation: editar / eliminar
      document.getElementById('lista_depositos').addEventListener('click', async function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('btn-edit')){
          // carregar detalhe e abrir modal
          const res = await fetch(detailUrlFor(id), {credentials:'same-origin'});
          if (!res.ok) return;
          const r = await res.json();
          if (!r.ok) { alert(r.error || 'Erro'); return; }
          const d = r.deposito;
          document.getElementById('edit_id').value = d.id;
          document.getElementById('edit_sector').value = d.sector_id || '';
          document.getElementById('edit_data').value = d.data_deposito || '';
          document.getElementById('edit_valor').value = d.valor || '';
          document.getElementById('edit_obs').value = d.observacao || '';
          new bootstrap.Modal(document.getElementById('modalEditarDeposito')).show();
        } else if (btn.classList.contains('btn-delete')){
          if (!confirm('Confirma eliminar este depósito?')) return;
          const res = await fetch(deleteUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
            body: JSON.stringify({id: id})
          });
          if (!res.ok){ alert('Erro ao eliminar'); return; }
          const r = await res.json();
          if (!r.ok){ alert(r.error || 'Erro'); return; }
          carregarLista(); carregarTotal();
        }
      });

      // salvar edição
      document.getElementById('btn_edit_save').addEventListener('click', async function(){
        const id = document.getElementById('edit_id').value;
        const payload = {
          sector_id: document.getElementById('edit_sector').value || null,
          data_deposito: document.getElementById('edit_data').value || null,
          valor: document.getElementById('edit_valor').value || null,
          observacao: document.getElementById('edit_obs').value || ''
        };
        const url = editUrlFor(id);
        const res = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
          body: JSON.stringify(payload)
        });
        if (!res.ok){ alert('Erro ao atualizar'); return; }
        const r = await res.json();
        if (!r.ok){ alert(r.error || 'Erro'); return; }
        bootstrap.Modal.getInstance(document.getElementById('modalEditarDeposito')).hide();
        carregarLista(); carregarTotal();
      });

      // carregar iniciais
      carregarLista();
      carregarTotal();
    });
</script>
{% endblock %}