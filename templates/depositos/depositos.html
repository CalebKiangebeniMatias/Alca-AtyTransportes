{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg,#007bff,#00bcd4);">
      <h5 class="mb-0 fw-semibold"><i class="fas fa-piggy-bank me-2"></i>Dep√≥sitos por Sector</h5>
      <small class="fw-light">Registe e consulte dep√≥sitos</small>
    </div>

    <div class="card-body p-4">
      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="tabs-dep">
        <li class="nav-item"><button class="nav-link active fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-reg"><i class="fas fa-plus-circle me-1"></i>Registrar</button></li>
        <li class="nav-item"><button class="nav-link fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-list"><i class="fas fa-list me-1"></i>Listar</button></li>
        <li class="nav-item"><button class="nav-link fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-total"><i class="fas fa-coins me-1"></i>Totais</button></li>
      </ul>

      <div class="tab-content mt-3">
        <!-- REGISTRAR -->
        <div class="tab-pane fade show active" id="tab-reg">
          <form id="form_deposito" class="row g-3" onsubmit="return false;">
            {% csrf_token %}
            <div class="col-md-4">
              <label class="form-label fw-semibold">Sector</label>
              <select id="dep_sector" class="form-select shadow-sm">
                <option value="">-- Escolha sector --</option>
                {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Data</label>
              <input id="dep_data" type="date" class="form-control shadow-sm" value="{{ now|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Valor</label>
              <input id="dep_valor" type="number" step="0.01" class="form-control shadow-sm" placeholder="0.00">
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Observa√ß√£o</label>
              <textarea id="dep_obs" class="form-control shadow-sm" rows="2" placeholder="Observa√ß√µes opcionais..."></textarea>
            </div>
            <div class="col-12 text-end mt-2">
              <button id="btn_dep_save" class="btn btn-primary px-4 shadow-sm"><i class="fas fa-save me-1"></i>Salvar Dep√≥sito</button>
            </div>
          </form>
        </div>

        <!-- LISTAR -->
        <div class="tab-pane fade" id="tab-list">
          <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <select id="filter_sector" class="form-select w-auto shadow-sm">
              <option value="">Todos sectores</option>
              {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
            </select>

            <!-- üîπ Filtros mensais -->
            <select id="filter_year" class="form-select w-auto shadow-sm">
              <option value="">Ano</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
            </select>

            <select id="filter_month" class="form-select w-auto shadow-sm">
              <option value="">M√™s</option>
              <option value="01">01</option>
              <option value="02">02</option>
              <option value="03">03</option>
              <option value="04">04</option>
              <option value="05">05</option>
              <option value="06">06</option>
              <option value="07">07</option>
              <option value="08">08</option>
              <option value="09">09</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>

            <button id="btn_reload" class="btn btn-outline-primary shadow-sm"><i class="fas fa-sync-alt me-1"></i>Recarregar</button>
          </div>
          <div id="lista_depositos" class="p-2 bg-light rounded-3 shadow-sm" style="max-height:420px; overflow:auto;"></div>
        </div>

        <!-- TOTAIS -->
        <div class="tab-pane fade" id="tab-total">
          <div class="row g-4 align-items-end">
            <div class="col-md-3">
              <label class="form-label fw-semibold">Sector</label>
              <select id="total_sector" class="form-select shadow-sm">
                <option value="">Todos sectores</option>
                {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold">Ano</label>
              <select id="total_year" class="form-select shadow-sm">
                <option value="">--</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">M√™s</label>
              <select id="total_month" class="form-select shadow-sm">
                <option value="">--</option>
                <option value="01">01</option>
                <option value="02">02</option>
                <option value="03">03</option>
                <option value="04">04</option>
                <option value="05">05</option>
                <option value="06">06</option>
                <option value="07">07</option>
                <option value="08">08</option>
                <option value="09">09</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </div>

            <div class="col-md-3 text-end">
              <label class="form-label fw-semibold">Total de Dep√≥sitos</label>
              <div class="h3 text-success fw-bold" id="total_valor">0,00 Kz</div>
              <button id="btn_total_reload" class="btn btn-outline-primary mt-2 shadow-sm"><i class="fas fa-sync-alt me-1"></i>Atualizar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditarDeposito" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="form_edit_deposito" class="modal-content border-0 shadow rounded-4" onsubmit="return false;">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-edit me-1"></i>Editar Dep√≥sito</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit_id">
        <div class="mb-2">
          <label class="form-label">Sector</label>
          <select id="edit_sector" class="form-select shadow-sm">
            <option value="">-- Escolha sector --</option>
            {% for s in sectores %}<option value="{{ s.id }}">{{ s.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Data</label>
          <input id="edit_data" type="date" class="form-control shadow-sm">
        </div>
        <div class="mb-2">
          <label class="form-label">Valor</label>
          <input id="edit_valor" type="number" step="0.01" class="form-control shadow-sm">
        </div>
        <div class="mb-2">
          <label class="form-label">Observa√ß√£o</label>
          <textarea id="edit_obs" class="form-control shadow-sm" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn_edit_save" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i>Salvar</button>
        <button type="button" class="btn btn-secondary px-3" data-bs-dismiss="modal">Fechar</button>
      </div>
    </form>
  </div>
</div>

<!-- SCRIPT PRINCIPAL -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop() || '';
  const saveUrl = "{% url 'depositos_save' %}";
  const listUrl = "{% url 'depositos_list' %}";
  const detailUrlTemplate = "{% url 'depositos_detail' 0 %}";
  const editUrlTemplate = "{% url 'depositos_edit' 0 %}";
  const deleteUrl = "{% url 'depositos_delete' %}";

  const fmt = new Intl.NumberFormat('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const listaDiv = document.getElementById('lista_depositos');
  const btnSave = document.getElementById('btn_dep_save');
  const totalValor = document.getElementById('total_valor');

  function toast(msg, type='success'){
    const color = type === 'error' ? 'bg-danger' :
                  type === 'warning' ? 'bg-warning text-dark' : 'bg-success';
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${color} border-0 position-fixed top-0 end-0 m-3`;
    toast.role = 'alert';
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {delay: 3000});
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
  }

  function detailUrlFor(id){ return detailUrlTemplate.replace('/0/','/'+id+'/'); }
  function editUrlFor(id){ return editUrlTemplate.replace('/0/','/'+id+'/edit/').replace('/0/edit/','/'+id+'/edit/'); }

  async function carregarLista(sec=null){
    const year = document.getElementById('filter_year').value || '';
    const month = document.getElementById('filter_month').value || '';

    const params = new URLSearchParams();
    if(sec) params.append('sector_id', sec);
    if(year) params.append('year', year);
    if(month) params.append('month', month);

    listaDiv.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border"></div><br>Carregando...</div>';
    const res = await fetch(listUrl + '?' + params.toString(), {credentials:'same-origin'});
    if (!res.ok) return;
    const data = await res.json();
    listaDiv.innerHTML = '';
    if (!data.ok || data.depositos.length === 0){
      listaDiv.innerHTML = '<div class="alert alert-light text-center">Nenhum dep√≥sito encontrado</div>';
      return;
    }
    data.depositos.forEach(d=>{
      const valorFmt = fmt.format(parseFloat(d.valor || 0)) + ' Kz';
      const el = document.createElement('div');
      el.className = 'border rounded p-2 mb-2 bg-light text-dark fade-in';
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${d.sector}</strong> ‚Äî ${d.data_deposito || '‚Äî'}
            <div class="small text-muted">${d.observacao || ''}</div>
          </div>
          <div class="text-end">
            <div class="text-success fw-bold">${valorFmt}</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-secondary btn-edit" data-id="${d.id}">Editar</button>
              <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${d.id}">Eliminar</button>
            </div>
          </div>
        </div>`;
      listaDiv.appendChild(el);
    });
  }

  async function carregarTotal(sec=null){
    const year = document.getElementById('total_year').value || '';
    const month = document.getElementById('total_month').value || '';

    const params = new URLSearchParams();
    if(sec) params.append('sector_id', sec);
    if(year) params.append('year', year);
    if(month) params.append('month', month);

    totalValor.textContent = '...';
    const res = await fetch(listUrl + '?' + params.toString(), {credentials:'same-origin'});
    if (!res.ok) return;
    const data = await res.json();
    const total = parseFloat(data.total || 0);
    totalValor.textContent = fmt.format(total) + ' Kz';
  }

  // Salvar novo dep√≥sito
  btnSave.addEventListener('click', async e=>{
    e.preventDefault();
    const sector = document.getElementById('dep_sector').value;
    const data = document.getElementById('dep_data').value;
    const valor = document.getElementById('dep_valor').value;
    const obs = document.getElementById('dep_obs').value;
    if (!sector || !valor){ toast('Sector e valor s√£o obrigat√≥rios', 'warning'); return; }

    btnSave.disabled = true;
    btnSave.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';
    const res = await fetch(saveUrl, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify({sector_id: parseInt(sector), data_deposito: data, valor: valor, observacao: obs})
    });
    btnSave.disabled = false;
    btnSave.textContent = 'Salvar Dep√≥sito';
    const r = await res.json();
    if (!r.ok){ toast(r.error || 'Erro ao salvar', 'error'); return; }
    toast('‚úÖ Dep√≥sito registrado com sucesso!');
    document.getElementById('dep_valor').value = '';
    document.getElementById('dep_obs').value = '';
    carregarLista(); carregarTotal();
  });

  // Listar e Totais
  document.getElementById('btn_reload').addEventListener('click', () => carregarLista(document.getElementById('filter_sector').value || null));
  document.getElementById('btn_total_reload').addEventListener('click', () => carregarTotal(document.getElementById('total_sector').value || null));

  // Editar / Excluir
  listaDiv.addEventListener('click', async e=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const id = btn.dataset.id;

    if (btn.classList.contains('btn-edit')){
      const res = await fetch(detailUrlFor(id), {credentials:'same-origin'});
      const r = await res.json();
      if (!r.ok){ toast(r.error || 'Erro ao carregar', 'error'); return; }
      const d = r.deposito;
      document.getElementById('edit_id').value = d.id;
      document.getElementById('edit_sector').value = d.sector_id || '';
      document.getElementById('edit_data').value = d.data_deposito || '';
      document.getElementById('edit_valor').value = d.valor || '';
      document.getElementById('edit_obs').value = d.observacao || '';
      new bootstrap.Modal(document.getElementById('modalEditarDeposito')).show();
    }

    if (btn.classList.contains('btn-delete')){
      if (!confirm('Eliminar este dep√≥sito?')) return;
      const res = await fetch(deleteUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
        body: JSON.stringify({id})
      });
      const r = await res.json();
      if (!r.ok){ toast(r.error || 'Erro ao eliminar', 'error'); return; }
      toast('üóëÔ∏è Dep√≥sito removido.');
      carregarLista(); carregarTotal();
    }
  });

  // Salvar edi√ß√£o
  document.getElementById('btn_edit_save').addEventListener('click', async ()=>{
    const id = document.getElementById('edit_id').value;
    const payload = {
      sector_id: document.getElementById('edit_sector').value || null,
      data_deposito: document.getElementById('edit_data').value || null,
      valor: document.getElementById('edit_valor').value || null,
      observacao: document.getElementById('edit_obs').value || ''
    };
    const res = await fetch(editUrlFor(id), {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken},
      body: JSON.stringify(payload)
    });
    const r = await res.json();
    if (!r.ok){ toast(r.error || 'Erro ao atualizar', 'error'); return; }
    bootstrap.Modal.getInstance(document.getElementById('modalEditarDeposito')).hide();
    toast('‚úèÔ∏è Dep√≥sito atualizado!');
    carregarLista(); carregarTotal();
  });

  // Iniciar
  carregarLista();
  carregarTotal();
});
</script>

<style>
  .form-control, .form-select { border-radius: 10px; transition: 0.2s; }
  .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.15rem rgba(13,110,253,0.25); }

  .nav-tabs .nav-link {
    border: none; color: #495057; background: #f8f9fa;
    border-radius: 8px 8px 0 0; margin-right: 5px;
  }
  .nav-tabs .nav-link.active {
    background: linear-gradient(90deg, #007bff, #00bcd4);
    color: white; box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  }
  .fade-in { animation: fadeIn .3s ease-in-out; }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>
{% endblock %}
